# ğŸ—ï¸ Complete Architecture Diagram

## Entire Application Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FLUTBOOK AUDIOBOOK SCANNER                         â”‚
â”‚                                                                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                          â”‚   User Selects Directory â”‚                        â”‚
â”‚                          â”‚   (via FilePicker)       â”‚                        â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                       â”‚                                     â”‚
â”‚                                       â–¼                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                    â”‚  DirectorySelectionScreen            â”‚                 â”‚
â”‚                    â”‚  (ConsumerStatefulWidget)            â”‚                 â”‚
â”‚                    â”‚                                      â”‚                 â”‚
â”‚                    â”‚  - Shows selected directory path     â”‚                 â”‚
â”‚                    â”‚  - "Continue" button enabled         â”‚                 â”‚
â”‚                    â”‚  - Injects use case from Riverpod    â”‚                 â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                 â”‚                                           â”‚
â”‚                    User Presses "Continue"                                 â”‚
â”‚                                 â”‚                                           â”‚
â”‚                                 â–¼                                           â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                  â”‚ Get ScanLibraryUseCase from  â”‚                           â”‚
â”‚                  â”‚ ref.read(provider)           â”‚                           â”‚
â”‚                  â”‚                              â”‚                           â”‚
â”‚                  â”‚ Riverpod ensures:            â”‚                           â”‚
â”‚                  â”‚ - Database initialized       â”‚                           â”‚
â”‚                  â”‚ - Datasources ready          â”‚                           â”‚
â”‚                  â”‚ - All dependencies injected  â”‚                           â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                               â”‚                                             â”‚
â”‚                               â–¼                                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚    ScanLibraryUseCaseImpl.execute(directoryPath)    â”‚             â”‚
â”‚         â”‚                                                     â”‚             â”‚
â”‚         â”‚  Orchestrates the complete workflow:               â”‚             â”‚
â”‚         â”‚                                                     â”‚             â”‚
â”‚         â”‚  1. EXTRACT METADATA                               â”‚             â”‚
â”‚         â”‚     â”œâ”€ Call MetadataExtractionDatasource           â”‚             â”‚
â”‚         â”‚     â”œâ”€ scanDirectoryForAudioFiles(path)            â”‚             â”‚
â”‚         â”‚     â”‚  â†’ List<String> of audio file paths          â”‚             â”‚
â”‚         â”‚     â”‚                                              â”‚             â”‚
â”‚         â”‚     â””â”€ For each file:                              â”‚             â”‚
â”‚         â”‚        â”œâ”€ extractMetadata(filePath)                â”‚             â”‚
â”‚         â”‚        â”‚  â†’ Audiobook or null                      â”‚             â”‚
â”‚         â”‚        â”œâ”€ Collect errors (don't fail)              â”‚             â”‚
â”‚         â”‚        â””â”€ Continue to next file                    â”‚             â”‚
â”‚         â”‚                                                     â”‚             â”‚
â”‚         â”‚  2. SAVE TO DATABASE                               â”‚             â”‚
â”‚         â”‚     â”œâ”€ Call AudiobookLocalDatasource               â”‚             â”‚
â”‚         â”‚     â”œâ”€ saveAudiobooks(audiobooks)                  â”‚             â”‚
â”‚         â”‚     â”œâ”€ Isar write transaction                      â”‚             â”‚
â”‚         â”‚     â””â”€ All-or-nothing save                         â”‚             â”‚
â”‚         â”‚                                                     â”‚             â”‚
â”‚         â”‚  3. RETURN RESULTS                                 â”‚             â”‚
â”‚         â”‚     â”œâ”€ scannedFiles: int                           â”‚             â”‚
â”‚         â”‚     â”œâ”€ elapsedTime: Duration                       â”‚             â”‚
â”‚         â”‚     â”œâ”€ errors: List<String>                        â”‚             â”‚
â”‚         â”‚     â”œâ”€ totalSize: int                              â”‚             â”‚
â”‚         â”‚     â””â”€ scanCompletedAt: DateTime                   â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â”‚                                                     â”‚
â”‚      Result received back in DirectorySelectionScreen                     â”‚
â”‚                      â”‚                                                     â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚          â”‚                       â”‚                                        â”‚
â”‚      Success            Success with errors                              â”‚
â”‚          â”‚                       â”‚                                        â”‚
â”‚          â”œâ”€ Show                 â”œâ”€ Show                                  â”‚
â”‚          â”‚  "Scanned X files     â”‚  "Scan completed with errors"          â”‚
â”‚          â”‚  in Y seconds"        â”‚  Check logs for details"               â”‚
â”‚          â”‚                       â”‚                                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚         â”‚  if (result.scannedFiles > 0)  â”‚                                â”‚
â”‚         â”‚    Navigate to Library         â”‚                                â”‚
â”‚         â”‚    pushReplacementNamed(       â”‚                                â”‚
â”‚         â”‚      '/library'                â”‚                                â”‚
â”‚         â”‚    )                           â”‚                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                      â”‚                                                     â”‚
â”‚                      â–¼                                                     â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚           â”‚   Library Screen     â”‚                                        â”‚
â”‚           â”‚                      â”‚                                        â”‚
â”‚           â”‚ - Query all          â”‚                                        â”‚
â”‚           â”‚   audiobooks from    â”‚                                        â”‚
â”‚           â”‚   Isar database      â”‚                                        â”‚
â”‚           â”‚                      â”‚                                        â”‚
â”‚           â”‚ - Display in         â”‚                                        â”‚
â”‚           â”‚   ListView           â”‚                                        â”‚
â”‚           â”‚                      â”‚                                        â”‚
â”‚           â”‚ - User can play,     â”‚                                        â”‚
â”‚           â”‚   search, organize   â”‚                                        â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Dependency Injection Layer (Riverpod)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      lib/bootstrap.dart      â”‚
                    â”‚                             â”‚
                    â”‚ - Initialize ProviderContainer
                    â”‚ - Early init databaseService
                    â”‚ - Run app                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  lib/core/provider/         â”‚
                    â”‚  providers.dart             â”‚
                    â”‚                             â”‚
                    â”‚  5 Riverpod Providers:      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ â”‚ â”‚ â”‚ â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚ â”‚ â”‚                   â”‚
         â–¼                  â–¼ â–¼ â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. databaseServiceProvider                         â”‚
    â”‚    â””â”€ Initializes Isar                            â”‚
    â”‚    â””â”€ Returns: DatabaseService singleton           â”‚
    â”‚    â””â”€ Status: â­ FOUNDATION (all depend on this)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ (Isar instance)
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚
                â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. audiobook         â”‚  â”‚ 3. jsonStorage   â”‚
    â”‚    LocalDatasource   â”‚  â”‚    Provider      â”‚
    â”‚    Provider          â”‚  â”‚                  â”‚
    â”‚                      â”‚  â”‚ Returns:         â”‚
    â”‚ Waits for:           â”‚  â”‚ JsonStorage      â”‚
    â”‚ - Isar initialized   â”‚  â”‚                  â”‚
    â”‚ - JsonStorage ready  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                      â”‚
    â”‚ Returns:             â”‚
    â”‚ AudiobookLocal       â”‚
    â”‚ Datasource           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. metadata                  â”‚
    â”‚    Extraction                â”‚
    â”‚    DatasourceProvider        â”‚
    â”‚                              â”‚
    â”‚ Returns:                     â”‚
    â”‚ MetadataExtractionDatasource â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚
         â–¼             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. scanLibraryUseCaseProvider               â”‚
    â”‚    (DEPENDS ON BOTH #2 AND #4)              â”‚
    â”‚                                             â”‚
    â”‚ Waits for:                                  â”‚
    â”‚ - AudiobookLocalDatasource ready            â”‚
    â”‚ - MetadataExtractionDatasource ready        â”‚
    â”‚                                             â”‚
    â”‚ Returns:                                    â”‚
    â”‚ ScanLibraryUseCaseImpl (fully wired)         â”‚
    â”‚                                             â”‚
    â”‚ This is what DirectorySelectionScreen uses! â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: From Files to Database

```
Directory Path
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MetadataExtractionDatasource.scanDirectoryForAudioFiles(path)  â”‚
â”‚                                                                 â”‚
â”‚ Recursively walks directory tree                               â”‚
â”‚ Finds files with extensions: .mp3, .m4a, .m4b, .wav, .flac     â”‚
â”‚                                                                 â”‚
â”‚ Returns: List<String>                                          â”‚
â”‚ ["/path/to/book1.mp3", "/path/to/book2.m4a", ...]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ For each file path:                          â”‚
                    â”‚                                              â”‚
                    â”‚ MetadataExtractionDatasource                 â”‚
                    â”‚   .extractMetadata(filePath)                 â”‚
                    â”‚                                              â”‚
                    â”‚ - Open file with just_audio                 â”‚
                    â”‚ - Extract ID3 tags or M4A metadata           â”‚
                    â”‚ - Parse duration                             â”‚
                    â”‚ - Extract title, author, album from tags     â”‚
                    â”‚ - Or extract from filename if no tags        â”‚
                    â”‚ - Extract chapters (M4B files)               â”‚
                    â”‚ - Extract cover art                          â”‚
                    â”‚                                              â”‚
                    â”‚ Returns: Audiobook or null                   â”‚
                    â”‚ {                                            â”‚
                    â”‚   id: "hash",                                â”‚
                    â”‚   title: "The Great Gatsby",                 â”‚
                    â”‚   author: "F. Scott Fitzgerald",             â”‚
                    â”‚   album: "Audiobooks",                       â”‚
                    â”‚   duration: Duration(hours: 8, minutes: 30), â”‚
                    â”‚   filePath: "/path/to/book.mp3",             â”‚
                    â”‚   chapters: [Chapter(...), ...],             â”‚
                    â”‚   totalSize: 1234567890,                     â”‚
                    â”‚   createdAt: DateTime.now(),                 â”‚
                    â”‚   completed: false,                          â”‚
                    â”‚ }                                            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Collect in List      â”‚
                            â”‚ audiobooks.add(book) â”‚
                            â”‚                      â”‚
                            â”‚ Errors collected     â”‚
                            â”‚ separately           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ if (audiobooks.isNotEmpty)             â”‚
                        â”‚   AudiobookLocalDatasource             â”‚
                        â”‚     .saveAudiobooks(audiobooks)        â”‚
                        â”‚                                        â”‚
                        â”‚ - Convert each Audiobook to            â”‚
                        â”‚   AudiobookModel                       â”‚
                        â”‚ - Begin Isar write transaction         â”‚
                        â”‚ - Insert all models                    â”‚
                        â”‚ - Commit transaction                   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Isar Database       â”‚
                            â”‚  audiobooks          â”‚
                            â”‚  collection          â”‚
                            â”‚                      â”‚
                            â”‚ [Audiobook, ...]    â”‚
                            â”‚ (persisted)          â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Library Screen       â”‚
                            â”‚ queries and displays â”‚
                            â”‚ all audiobooks       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Class Relationship Diagram (After Fix)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CLEAN ARCHITECTURE                             â”‚
â”‚                    (No Circular Dependencies)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PRESENTATION LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ DirectorySelectionScreen            â”‚
  â”‚ (ConsumerStatefulWidget)            â”‚
  â”‚                                     â”‚
  â”‚ - User selects directory            â”‚
  â”‚ - Injects ScanLibraryUseCase        â”‚
  â”‚ - Calls: useCase.execute(path)      â”‚
  â”‚ - Shows loading indicator           â”‚
  â”‚ - Displays results                  â”‚
  â”‚ - Navigates to Library              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ uses
               â–¼
DOMAIN LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ScanLibraryUseCase (Interface)             â”‚
  â”‚ + execute(String path): ScanResult         â”‚
  â”‚                                            â”‚
  â”‚ ScanLibraryUseCaseImpl (Implementation)     â”‚
  â”‚                                            â”‚
  â”‚ execute(path) {                            â”‚
  â”‚   1. Extract metadata (via extractor)      â”‚
  â”‚   2. Save to database (via datasource)     â”‚
  â”‚   3. Return results                        â”‚
  â”‚ }                                          â”‚
  â”‚                                            â”‚
  â”‚ Dependencies:                              â”‚
  â”‚ - MetadataExtractionDatasource   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ - AudiobookLocalDatasource   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚                               â”‚ â”‚             â”‚ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”˜
                                   â”‚ â”‚             â”‚
                                   â”‚ â”‚             â”‚
DATA LAYER                         â”‚ â”‚             â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                   â”‚ â”‚             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚
                    â–¼                â”‚             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ MetadataExtractionDatasource               â”‚
     â”‚ (Pure File Operations)                     â”‚
     â”‚                                            â”‚
     â”‚ + scanDirectoryForAudioFiles(path)         â”‚
     â”‚   â†’ List<String> audio file paths          â”‚
     â”‚                                            â”‚
     â”‚ + extractMetadata(filePath)                â”‚
     â”‚   â†’ Audiobook or null                      â”‚
     â”‚                                            â”‚
     â”‚ + isFileAccessible(filePath)               â”‚
     â”‚   â†’ bool                                   â”‚
     â”‚                                            â”‚
     â”‚ DEPENDENCIES: None âœ…                      â”‚
     â”‚ (Pure functions, no database access)       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
          [File System]
          Audio Files
          (*.mp3, *.m4a, etc)
                    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (other path)
                    â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ AudiobookLocalDatasource                   â”‚
     â”‚ (Pure Database Operations)                 â”‚
     â”‚                                            â”‚
     â”‚ + saveAudiobooks(audiobooks)               â”‚
     â”‚   â†’ saves to Isar                          â”‚
     â”‚                                            â”‚
     â”‚ + getAudiobooks()                          â”‚
     â”‚   â†’ List<Audiobook> from Isar              â”‚
     â”‚                                            â”‚
     â”‚ + getAudiobookById(id)                     â”‚
     â”‚   â†’ Audiobook or null                      â”‚
     â”‚                                            â”‚
     â”‚ + findAudiobooks(filter)                   â”‚
     â”‚   â†’ filtered List<Audiobook>               â”‚
     â”‚                                            â”‚
     â”‚ DEPENDENCIES:                              â”‚
     â”‚ - Isar instance âœ…                         â”‚
     â”‚ - JsonStorage âœ…                           â”‚
     â”‚ (Only what it needs, no metadata extractor)
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Isar Database     â”‚
            â”‚ audiobooks        â”‚
            â”‚ playback_sessions â”‚
            â”‚ user_profiles     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… KEY DIFFERENCES FROM BEFORE:
   - No circular dependencies
   - Each class can be tested independently
   - Clear layer separation
   - One-way dependency flow
   - Easy to inject mocks for testing
```

---

## State Management Flow (Riverpod)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Starts (bootstrap.dart)            â”‚
â”‚                                        â”‚
â”‚ 1. Create ProviderContainer            â”‚
â”‚ 2. Initialize databaseServiceProvider  â”‚
â”‚    (early database init)               â”‚
â”‚ 3. Run app with UncontrolledScope      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ User navigates to              â”‚
         â”‚ DirectorySelectionScreen       â”‚
         â”‚                                â”‚
         â”‚ (ConsumerStatefulWidget)       â”‚
         â”‚ Has access to: ref.read(),     â”‚
         â”‚ ref.watch(), ref.listen()      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ User selects directory         â”‚
         â”‚ and presses Continue           â”‚
         â”‚                                â”‚
         â”‚ _handleContinuePressed() {     â”‚
         â”‚   final useCase =              â”‚
         â”‚     await ref.read(            â”‚
         â”‚       scanLibraryUseCaseProvider
         â”‚         .future                â”‚
         â”‚     )                          â”‚
         â”‚                                â”‚
         â”‚   // Riverpod builds entire    â”‚
         â”‚   // dependency tree:          â”‚
         â”‚   //                           â”‚
         â”‚   // 1. Check if database      â”‚
         â”‚   //    initialized            â”‚
         â”‚   // 2. Create local ds        â”‚
         â”‚   // 3. Get metadata extractor â”‚
         â”‚   // 4. Create use case        â”‚
         â”‚   // 5. Return fully wired     â”‚
         â”‚   //    use case instance      â”‚
         â”‚ }                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Use case provided by Riverpod  â”‚
      â”‚                                â”‚
      â”‚ All dependencies already:      â”‚
      â”‚ âœ… Injected                    â”‚
      â”‚ âœ… Initialized                 â”‚
      â”‚ âœ… Ready to use                â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Execute scan:                  â”‚
         â”‚ useCase.execute(path)          â”‚
         â”‚                                â”‚
         â”‚ Workflow:                      â”‚
         â”‚ 1. Extract metadata            â”‚
         â”‚ 2. Save to database            â”‚
         â”‚ 3. Return results              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Results in ScanResult object:   â”‚
      â”‚ - scannedFiles: int             â”‚
      â”‚ - elapsedTime: Duration         â”‚
      â”‚ - errors: List<String>          â”‚
      â”‚ - totalSize: int                â”‚
      â”‚ - scanCompletedAt: DateTime     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Display results to user        â”‚
        â”‚                                â”‚
        â”‚ if (result.scannedFiles > 0)   â”‚
        â”‚   Navigate to /library         â”‚
        â”‚                                â”‚
        â”‚ else                           â”‚
        â”‚   Show error message           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Library Screen            â”‚
          â”‚                           â”‚
          â”‚ Queries Isar database:    â”‚
          â”‚ isar.audiobooks           â”‚
          â”‚  .where()                 â”‚
          â”‚  .findAll()               â”‚
          â”‚                           â”‚
          â”‚ Displays audiobooks       â”‚
          â”‚ in ListView               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

âœ… **Clean** - No circular dependencies
âœ… **Organized** - Clear layer separation
âœ… **Testable** - Each component independent
âœ… **Maintainable** - Easy to understand and modify
âœ… **Scalable** - Easy to add new features
âœ… **Complete** - Full scanning workflow working

**Ready to use! ğŸš€**
